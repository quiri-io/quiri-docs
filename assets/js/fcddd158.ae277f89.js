"use strict";(self.webpackChunkquiri_docs=self.webpackChunkquiri_docs||[]).push([[1726],{3905:function(e,t,a){a.d(t,{Zo:function(){return u},kt:function(){return c}});var r=a(7294);function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,r)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){n(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,r,n=function(e,t){if(null==e)return{};var a,r,n={},i=Object.keys(e);for(r=0;r<i.length;r++)a=i[r],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)a=i[r],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var l=r.createContext({}),p=function(e){var t=r.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},u=function(e){var t=p(e.components);return r.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},m=r.forwardRef((function(e,t){var a=e.components,n=e.mdxType,i=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),m=p(a),c=n,h=m["".concat(l,".").concat(c)]||m[c]||d[c]||i;return a?r.createElement(h,o(o({ref:t},u),{},{components:a})):r.createElement(h,o({ref:t},u))}));function c(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var i=a.length,o=new Array(i);o[0]=m;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:n,o[1]=s;for(var p=2;p<i;p++)o[p]=a[p];return r.createElement.apply(null,o)}return r.createElement.apply(null,a)}m.displayName="MDXCreateElement"},6398:function(e,t,a){a.r(t),a.d(t,{assets:function(){return u},contentTitle:function(){return l},default:function(){return c},frontMatter:function(){return s},metadata:function(){return p},toc:function(){return d}});var r=a(7462),n=a(3366),i=(a(7294),a(3905)),o=["components"],s={},l="Server Management",p={unversionedId:"server-management",id:"server-management",title:"Server Management",description:"Currently there is only a prod instance of the synapse server live. It is deployed to a machine that we have on DigitalOcean using an ansible script. The script takes a plain linux box and sets it up to run the synapse server. This is the original ansible script. We have a fork of this repo under the quiri-io organization.",source:"@site/docs/server-management.md",sourceDirName:".",slug:"/server-management",permalink:"/docs/server-management",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/server-management.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Translate your site",permalink:"/docs/docusaurus-intro/tutorial-extras/translate-your-site"},next:{title:"Whitelabelling Element Android",permalink:"/docs/whitelabelling-element-android"}},u={},d=[],m={toc:d};function c(e){var t=e.components,a=(0,n.Z)(e,o);return(0,i.kt)("wrapper",(0,r.Z)({},m,a,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"server-management"},"Server Management"),(0,i.kt)("p",null,"Currently there is only a prod instance of the synapse server live. It is deployed to a machine that we have on DigitalOcean using an ansible script. The script takes a plain linux box and sets it up to run the synapse server. ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/spantaleev/matrix-docker-ansible-deploy"},"This is the original ansible script.")," We have a fork of this repo under the quiri-io organization."),(0,i.kt)("h1",{id:"domain-name"},"Domain name"),(0,i.kt)("p",null,"The domain name (quiri.io) is owned by Nigel and is under his personal email.\nI used Google Domains to set up the matrix.quiri.io and element.quiri.io domains and have them pointing to the DigitalOcean droplet\n",(0,i.kt)("a",{parentName:"p",href:"https://www.youtube.com/watch?v=YfAcvLuFMZI"},"https://www.youtube.com/watch?v=YfAcvLuFMZI"),"\nAs per ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/spantaleev/matrix-docker-ansible-deploy/blob/master/docs/configuring-dns.md"},"the DNS Setup instructions")," from the ansible script"),(0,i.kt)("h1",{id:"configuring-the-ansible-playbook"},(0,i.kt)("a",{parentName:"h1",href:"https://github.com/quiri-io/matrix-docker-ansible-deploy/blob/master/docs/configuring-playbook.md#configuring-the-ansible-playbook"},"Configuring the Ansible Playbook")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"the ",(0,i.kt)("inlineCode",{parentName:"li"},"vars.yml")," is in bitwarden under ",(0,i.kt)("inlineCode",{parentName:"li"},"ansible vars.yml")),(0,i.kt)("li",{parentName:"ul"},"the ",(0,i.kt)("inlineCode",{parentName:"li"},"hosts")," file is in bitwarden under ",(0,i.kt)("inlineCode",{parentName:"li"},"ansible hosts file"))),(0,i.kt)("h1",{id:"setting-up-droplet-to-be-sshed-into-using-ssh-key"},(0,i.kt)("a",{parentName:"h1",href:"https://docs.digitalocean.com/products/droplets/how-to/connect-with-ssh/"},"Setting up Droplet to be sshed into using SSH Key")),(0,i.kt)("p",null,"Needed to set up the ",(0,i.kt)("a",{parentName:"p",href:"https://docs.digitalocean.com/products/droplets/how-to/add-ssh-keys/to-account/"},"droplet with the key ahead of time"),"\nI had to destroy the droplet and recreate it with the SSH key option\nI named my ssh key locally to id_rsa_matrix_quiri, and stored a passphrase for it in Bitwarden"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"the private/public key are also in bitwarden",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"you will need to create the files manually and paste the contents in and then use the chmod commands that are attached to them to set their permissions appropriately")))),(0,i.kt)("h1",{id:"running-the-ansible-script"},"Running the ansible script"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/quiri-io/matrix-docker-ansible-deploy/blob/master/docs/ansible.md#using-ansible-via-docker"},"Use the docker option.")),(0,i.kt)("li",{parentName:"ul"},"You will need to change the mapping to the id_rsa file if you gave it a non-standard name like I did"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/quiri-io/matrix-docker-ansible-deploy/blob/master/docs/configuring-playbook-base-domain-serving.md"},"Before running, make sure that the matrix_nginx_proxy_base_domain_serving_enabled: true is set and the domain record is set appropriately")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/quiri-io/matrix-docker-ansible-deploy/blob/master/docs/installing.md"},"Finally running the ansible script"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"the script will ask for the password for the private key. You can find it in bitwarden as a custom field under ",(0,i.kt)("inlineCode",{parentName:"li"},"id_rsa_matrix_quiri private key"))))),(0,i.kt)("p",null,"Register first admin user manually\n",(0,i.kt)("a",{parentName:"p",href:"https://github.com/spantaleev/matrix-docker-ansible-deploy/blob/master/docs/registering-users.md"},"https://github.com/spantaleev/matrix-docker-ansible-deploy/blob/master/docs/registering-users.md")),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://github.com/spantaleev/matrix-docker-ansible-deploy/blob/master/docs/configuring-playbook-synapse-admin.md"},"Then set up the synapse admin"),"\nAnd create other users there"),(0,i.kt)("h1",{id:"upgrading-synapse"},"Upgrading Synapse"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/quiri-io/matrix-docker-ansible-deploy/blob/master/docs/maintenance-upgrading-services.md"},"follow these docs"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"I had to upgrade because the flutter SDK was not compatible with the server version",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"I may have to upgrade the postgres database as well because it was a major version bump...")))))),(0,i.kt)("h1",{id:"deploying-a-custom-docker-image"},"Deploying a custom docker image"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"We are developing on top of synapse and thus need to be deploying our version of synapse rather than the one distributed on dockerhub")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Since we are using DigitalOcean for the server right now, we will also use ",(0,i.kt)("a",{parentName:"p",href:"https://www.digitalocean.com/products/container-registry"},"the digital ocean private container registry"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"New images are pushed to ",(0,i.kt)("a",{parentName:"p",href:"https://docs.digitalocean.com/products/container-registry/how-to/use-registry-docker-kubernetes/"},"the registry from local"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"The ansible scripts need to be updated to accept login details and then pull from the private registry")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Looks like you can build from a git repo\u2026 but then you would need to have the ssh key\u2026 probably just do the docker login separately and pull from the private repo"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"The docker image that is pulled for synapse is set here ",(0,i.kt)("inlineCode",{parentName:"li"},"roles/matrix-synapse/defaults/main.yml")))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"The actual pull happens here roles/matrix-synapse/tasks/synapse/setup_install.yml"),(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"There is a way to have matrix built from a repository BUT it looks like it will need to be a public repo. And it needs to use the same versioning that the official repo does"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Looks like the way forward is to add a new option that pulls from a provided registry URL after logging in to the private repo (if the repo is private)"))))}c.isMDXComponent=!0}}]);