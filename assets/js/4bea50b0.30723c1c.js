"use strict";(self.webpackChunkquiri_docs=self.webpackChunkquiri_docs||[]).push([[517],{9296:function(e){e.exports=JSON.parse('{"blogPosts":[{"id":"listening-for-new-messages-with-the-matrix-sdk","metadata":{"permalink":"/quiri-docs/blog/listening-for-new-messages-with-the-matrix-sdk","source":"@site/blog/2024-12-19-listening-for-new-messages-with-the-matrix-sdk.md","title":"Listening for New Messages With the Matrix SDK","description":"Background","date":"2024-12-19T00:00:00.000Z","formattedDate":"December 19, 2024","tags":[{"label":"quiri","permalink":"/quiri-docs/blog/tags/quiri"},{"label":"guide","permalink":"/quiri-docs/blog/tags/guide"}],"readingTime":1.84,"truncated":false,"authors":[{"name":"Nigel Maynard","title":"Quiri Founder","url":"https://github.com/nigel-smk","imageURL":"https://github.com/nigel-smk.png","key":"nigel"}],"frontMatter":{"slug":"listening-for-new-messages-with-the-matrix-sdk","title":"Listening for New Messages With the Matrix SDK","authors":["nigel"],"tags":["quiri","guide"]},"nextItem":{"title":"Opening a Quiri with Another User","permalink":"/quiri-docs/blog/opening-a-quiri-with-another-user"}},"content":"## Background\\n[Almost all actions in matrix are expressed as `users` sending `events` to `rooms`.](https://matrix.org/docs/matrix-concepts/rooms_and_events/) This makes intuitive sense when it comes to message events but works equally well for non-message events (e.g. add user event, change room name event, etc). When a user adds an event to a room, [it is first added to the event graph on their personal client, then it is replicated to the user\'s home server and then it is replicated to all other clients that are in that room.](https://matrix.org/docs/matrix-concepts/elements-of-matrix/#client) Quiri is written in Dart and uses the matrix dart sdk to handle a lot of the client-server relationship. This includes maintaining the local copy of the current state of a room\'s state and listening for updates to that room\'s state. This guide goes into details about how that relationship is maintained so that we can build the quiri client appropriately.\\n\\n## Listening for events\\nOn [app startup](https://github.com/quiri-io/quiri_flutter/blob/8405271b51a3c85884502042387289cdc083149f/lib/config/configure_matrix.dart#L4-L11), we currently call the [init method](https://github.com/famedly/matrix-dart-sdk/blob/501c457ea130481ba5b52d45d4d0ff37b8707964/lib/src/client.dart#L1502-L1519). This method does a number of things including kicking off the first [_sync](https://github.com/famedly/matrix-dart-sdk/blob/501c457ea130481ba5b52d45d4d0ff37b8707964/lib/src/client.dart#L1789-L1800) request.\\n\\nThis sync call can be awaited as a whole, or you can provide the `waitForFirstSync` as `false` and instead await the `roomsLoading`, `_accountDataLoading` and `userDeviceKeysLoading` futures individually. We will await on the init for now for simplicity.\\n\\nAfter the initial sync, the client will begin a [_backgroundSync](https://github.com/famedly/matrix-dart-sdk/blob/501c457ea130481ba5b52d45d4d0ff37b8707964/lib/src/client.dart#L1771-L1781) that [long polls](https://spec.matrix.org/latest/#architecture) every 30 seconds (configurable).\\n\\n## Replicating the state in the client\\nEach sync job uses the [_handleSync](https://github.com/famedly/matrix-dart-sdk/blob/501c457ea130481ba5b52d45d4d0ff37b8707964/lib/src/client.dart#L1969-L2021) method to perform the appropriate updates to state.\\n\\nFor example, in the [`_handleRoomEvents` sub-handler the updates are made in the following order:](https://github.com/famedly/matrix-dart-sdk/blob/501c457ea130481ba5b52d45d4d0ff37b8707964/lib/src/client.dart#L2277-L2284)\\n- the in-memory state (accessible from the SDK client object e.g. `client.rooms`)\\n- the client side database for persistent storage\\n- the SDK\'s [exposed event streams](https://github.com/famedly/matrix-dart-sdk/blob/501c457ea130481ba5b52d45d4d0ff37b8707964/lib/src/client.dart#L1254-L1285)\\n\\n## Reacting to new events in the UI\\nIn particular, how do we know when new messages have arrived? Let\'s look at how Fluffychat does it. First let\'s look at [where they render their chat boxes](https://gitlab.com/famedly/fluffychat/-/blob/f19bbcd0102e1b2982af9b988e9e6f7de9cc33a7/lib/pages/chat/chat_event_list.dart#L104-142). The messages are found in a room\'s `timeline`. The `timeline` is returned from the [SDK getTimeline method](https://github.com/famedly/matrix-dart-sdk/blob/42f44de2b13588aede30d5f64fc381ee1a72f90c/lib/src/room.dart#L1467-L1479). An `onUpdate` callback is passed to allow the UI to react to new messages arriving. Here is where [Fluffychat sets up the timeline listener for new messages](https://gitlab.com/famedly/fluffychat/-/blob/1911004d0540d3dea51da327dd32d82d061675f5/lib/pages/chat/chat.dart#L287-340)"},{"id":"opening-a-quiri-with-another-user","metadata":{"permalink":"/quiri-docs/blog/opening-a-quiri-with-another-user","source":"@site/blog/2024-12-04-user-discovery-in-quiri.md","title":"Opening a Quiri with Another User","description":"The Problem","date":"2024-12-04T00:00:00.000Z","formattedDate":"December 4, 2024","tags":[{"label":"quiri","permalink":"/quiri-docs/blog/tags/quiri"},{"label":"solutioning","permalink":"/quiri-docs/blog/tags/solutioning"}],"readingTime":5.015,"truncated":false,"authors":[{"name":"Nigel Maynard","title":"Quiri Founder","url":"https://github.com/nigel-smk","imageURL":"https://github.com/nigel-smk.png","key":"nigel"}],"frontMatter":{"slug":"opening-a-quiri-with-another-user","title":"Opening a Quiri with Another User","authors":["nigel"],"tags":["quiri","solutioning"]},"prevItem":{"title":"Listening for New Messages With the Matrix SDK","permalink":"/quiri-docs/blog/listening-for-new-messages-with-the-matrix-sdk"},"nextItem":{"title":"Starting and Restarting Sessions","permalink":"/quiri-docs/blog/starting-and-restarting-sessions"}},"content":"## The Problem\\nIn the current dev build of Quiri, the only way to open a conversation with a user is to know their username and to enter it perfectly in the `conversation partner` field. Here we explore ways to improve this experience, including:\\n- inviting a user via their email or phone number (3rd party identifier / 3PID)\\n    - inviting users without an account to create an account to accept the invite and start the conversation\\n- a contact list or friends list to quickly open new quiris\\n- adding a friend using their quiri userID or displayname\\n\\nFor the MVP all rooms are to be private and 1-1 and there are no plans to help users discover one another on the platform (e.g. no public spaces for posting). Public posting is being considered for a future release.\\n\\n\\n\\n## What Matrix Offers\\nAs we are building on top of matrix, we should first attempt to leverage the features and patterns that they offer out of the box to minimize custom dev work.\\n\\n### Inviting a known user\\nThis is the flow that we are using in the dev build today. Matrix users come with identifiers that look a lot like emails (e.g. `@nigel:quiri.io`). When you want to open a room with a user you can address it in the same way that you would address an email: know the user\'s email exactly and write it correctly. If the address is wrong, the room will fail to open same as an email would fail to send.\\n\\n### User Directory Search\\nMatrix servers offer the ability to [search the user directory](https://spec.matrix.org/v1.11/client-server-api/#user-directory) for other users by their `user ID` or `display name`. This feature does not simply list the users though. Some search term must be passed (e.g. at least a single character like `a`) and only those users matching will be shown. As such, this is a feature that could help users find each other in two cases:\\n- the quiri userId/displayname was shared previously and the search provides some confirmation that the user actually exists and may provide suggestions if the userID/displayname was misspelt\\n- A user can try their friend\'s real name and hope they found the right person if the search returns a hit\\n\\n#### Configuration Options\\nThe `synapse` matrix server implementation offers [some configuration of the search results](https://element-hq.github.io/synapse/latest/usage/configuration/config_documentation.html#user_directory) but it is limited in it\'s configurability.\\n\\nAt it\'s most open, it returns search results for all users on the server and other servers. For the MVP this may be acceptable but as the community grows it could enable spammers to abuse the platform and harass random users.\\n\\nThe one restriction that is offered is to set the `search_all_users` property to false in which,\\n> \\"...search results will only contain users visible in public rooms and users sharing a room with the requester.\\"\\nWith this flag set we might be able to use this feature to enable searching of all users you have interacted with before as long as you are still in a room with each of those users.\\n\\n### Third Party Invites\\nMatrix offers a way to invite someone to a room using a [third-party invite](https://spec.matrix.org/v1.12/client-server-api/#third-party-invites). If the user already has an account associated with that email/phone then they are added to the room. If they don\'t have an account yet, the user is sent an email inviting them to join quiri (and the room they were invited to). Once they have created an account associated with their email they can join the room.\\n\\n### List all users in a room\\nFor a given room, [all members in that room can be listed.](https://playground.matrix.org/#get-/_matrix/client/v3/rooms/-roomId-/members) this does not help us with our problems directly but may be useful as a workaround for storing a contact list.\\n\\n### Search a room\\nMatrix offers the [server-side indexing and search of room event contents](https://playground.matrix.org/#post-/_matrix/client/v3/search). This also does not help us directly but could enable the searching of a \\"contact list\\" room.\\n\\n\\n\\n## Our Solution\\n\\n### Inviting someone to a room using their email\\nThe built-in third party invite functionality appears to handle this. A more thorough audit should be performed against a local instance of Synapse.\\n\\n### Contact list\\n[Matrix does not currently offer a contact list functionality](https://github.com/matrix-org/matrix-spec/issues/111). If we want this functionality, the out-of-the box solution will be to create a non-chat room for each user in which only their contact list is stored. Non-chat rooms are an [expected use-case for Matrix](https://spec.matrix.org/v1.12/client-server-api/#types) so it\'s not terribly hacky but the functionality will be limited. The [room search feature](https://playground.matrix.org/#post-/_matrix/client/v3/search) could possibly be used for filtering the contact list but sorting will likely be client side. The client will handle the logic for when a user is added/removed from a \\"contact list\\" room and will have to be careful to not include the contact list room in the quiri list. A more thorough audit of the room invite functionality should be performed to detail how \\"contact list\\" room invites and acceptances would map to \\"contact list\\" invites and acceptances/rejections.\\n\\n### Adding a friend to your contact list\\nFor the MVP there will be two ways in which you can add a user to your friends list:\\n- knowing their email\\n- knowing their username or display name\\n\\nThis feels quite restricted but making user directories searchable trades the convenience of searching for users by name with the risk of users being spammed. While this is a low risk today, as the platform grows, this is the kind of thing that crushes communication platforms.\\n\\nTaking Discord as a reference, they offer adding a friend strictly by username but you can add someone to a server by email.\\n\\n## Conclusion\\nOverall, the user experience will be:\\n- open conversations for the first time by providing their email (or knowing their username)\\n- a one-time use shareable add-me-as-a-friend link that can be pasted into an outside chat or email would be a nice way to make friend adding easier\\n- open further conversations with a user via your contact list"},{"id":"starting-and-restarting-sessions","metadata":{"permalink":"/quiri-docs/blog/starting-and-restarting-sessions","source":"@site/blog/2024-06-01-all-of-the-things-you-can-ask-about-a-piece-of-data.md","title":"Starting and Restarting Sessions","description":"Matrix SDK Sessions","date":"2024-06-01T00:00:00.000Z","formattedDate":"June 1, 2024","tags":[{"label":"guides","permalink":"/quiri-docs/blog/tags/guides"}],"readingTime":2.67,"truncated":false,"authors":[{"name":"Nigel Maynard","title":"Quiri Founder","url":"https://github.com/nigel-smk","imageURL":"https://github.com/nigel-smk.png","key":"nigel"}],"frontMatter":{"slug":"starting-and-restarting-sessions","title":"Starting and Restarting Sessions","authors":["nigel"],"tags":["guides"]},"prevItem":{"title":"Opening a Quiri with Another User","permalink":"/quiri-docs/blog/opening-a-quiri-with-another-user"},"nextItem":{"title":"Starting and Restarting Sessions","permalink":"/quiri-docs/blog/starting-and-restarting-sessions"}},"content":"## Matrix SDK Sessions\\n\\nMatrix uses access tokens to authenticate user requests. The Flutter SDK handles a lot of the token management for us.\\n\\nFor example, when setting the user\'s display name, there is no way to pass the auth token. This is because it is stored in a class variable and included in the request on our behalf.\\n\\nBut what happens to the access token when we shut down the app? The instance of the SDK class will be disposed and the token will go with it. This is why the Matrix Client can be provided a databaseBuilder when being created. The SDK will store the access token, amongst other things in this database and [fetch them on startup](https://github.com/famedly/matrix-dart-sdk/blob/544888fe33a14e0610b2916b5069656a06aeb299/lib/src/client.dart#L1430-L1459). This is what will allow us to keep users logged in even when the restart the app.\\n\\nThere remains the question of how long a client can stay logged in. It seems that the default for FluffyChat is to have long-lived access tokens. But the matrix spec allows for the use of refresh tokens for improved security.There exists a method [`refreshAccessToken()` that refreshes the access token](https://github.com/famedly/matrix-dart-sdk/blob/501c457ea130481ba5b52d45d4d0ff37b8707964/lib/src/client.dart#L241-L279) but it appears that FluffyChat doesn\'t use it... Looks like I\'ll need to schedule a task to refresh the token. \\n\\n## Other session data\\nWhile the matrix SDK has it\'s own ways to persist session data, there are also cases in which we will want to persist session data (e.g. the user\'s sign-up stage). For these non-matrix session data, we will use the [Hydrated Bloc package](https://pub.dev/packages/hydrated_bloc) to securely persist the session data.\\n\\n\\n# State Restoration in Flutter\\n[Thorough blog post](https://www.flutteris.com/blog/en/state_restoration)\\n- maybe use this primarily for navigation state and lean on hydrated bloc for other state?\\n- [goRouter state restoration example](https://github.com/flutter/packages/blob/main/packages/go_router/example/lib/others/state_restoration.dart)\\n- might need to use [statefulShellRoute?](https://github.com/tolo/flutter_packages/blob/nested-persistent-navigation/packages/go_router/example/lib/stateful_shell_route.dart)\\n- state restore is only for going from background to foreground if the OS reclaims the memory because it needs it\\n- when manually shutting down the app and restarting it, state restore does not work (at least for go_router)\\n\\n# Startup State Restoration\\n- If a user has never used the app\\n    - there is no state to restore and they should land on the landing page\\n- If a user has started the signup process, but has not yet registered an account (they are registered after picking their unique handle)\\n    - return the user to where they were in the signup process\\n- if a user exits out of the signup process before registering via the close button in the app\\n    - clear the app state entirely (including any signup progress)\\n- if a user registers an account successfully\\n    - clear all signup state (they are signed up now, so we don\'t have to go back!)\\n- if a user logs out after logging in\\n    - clear all state\\n- if a user logs in and they have not set their avatar or display name (last step of signup that occurs after registration)\\n    - detect when loading homepage and redirect user to create profile page\\n        - using route guards?\\n        - create profile page needs a logout option\\n        - the display name and avatar can be attached to a User HydratedBloc so that we can cache the avatar and displayname"},{"id":"starting-and-restarting-sessions","metadata":{"permalink":"/quiri-docs/blog/starting-and-restarting-sessions","source":"@site/blog/2024-05-12-starting-and-restarting-sessions.md","title":"Starting and Restarting Sessions","description":"Matrix SDK Sessions","date":"2024-05-12T00:00:00.000Z","formattedDate":"May 12, 2024","tags":[{"label":"guides","permalink":"/quiri-docs/blog/tags/guides"}],"readingTime":2.67,"truncated":false,"authors":[{"name":"Nigel Maynard","title":"Quiri Founder","url":"https://github.com/nigel-smk","imageURL":"https://github.com/nigel-smk.png","key":"nigel"}],"frontMatter":{"slug":"starting-and-restarting-sessions","title":"Starting and Restarting Sessions","authors":["nigel"],"tags":["guides"]},"prevItem":{"title":"Starting and Restarting Sessions","permalink":"/quiri-docs/blog/starting-and-restarting-sessions"},"nextItem":{"title":"Registering New Users with Matrix","permalink":"/quiri-docs/blog/registering-new-users"}},"content":"## Matrix SDK Sessions\\n\\nMatrix uses access tokens to authenticate user requests. The Flutter SDK handles a lot of the token management for us.\\n\\nFor example, when setting the user\'s display name, there is no way to pass the auth token. This is because it is stored in a class variable and included in the request on our behalf.\\n\\nBut what happens to the access token when we shut down the app? The instance of the SDK class will be disposed and the token will go with it. This is why the Matrix Client can be provided a databaseBuilder when being created. The SDK will store the access token, amongst other things in this database and [fetch them on startup](https://github.com/famedly/matrix-dart-sdk/blob/544888fe33a14e0610b2916b5069656a06aeb299/lib/src/client.dart#L1430-L1459). This is what will allow us to keep users logged in even when the restart the app.\\n\\nThere remains the question of how long a client can stay logged in. It seems that the default for FluffyChat is to have long-lived access tokens. But the matrix spec allows for the use of refresh tokens for improved security.There exists a method [`refreshAccessToken()` that refreshes the access token](https://github.com/famedly/matrix-dart-sdk/blob/501c457ea130481ba5b52d45d4d0ff37b8707964/lib/src/client.dart#L241-L279) but it appears that FluffyChat doesn\'t use it... Looks like I\'ll need to schedule a task to refresh the token. \\n\\n## Other session data\\nWhile the matrix SDK has it\'s own ways to persist session data, there are also cases in which we will want to persist session data (e.g. the user\'s sign-up stage). For these non-matrix session data, we will use the [Hydrated Bloc package](https://pub.dev/packages/hydrated_bloc) to securely persist the session data.\\n\\n\\n# State Restoration in Flutter\\n[Thorough blog post](https://www.flutteris.com/blog/en/state_restoration)\\n- maybe use this primarily for navigation state and lean on hydrated bloc for other state?\\n- [goRouter state restoration example](https://github.com/flutter/packages/blob/main/packages/go_router/example/lib/others/state_restoration.dart)\\n- might need to use [statefulShellRoute?](https://github.com/tolo/flutter_packages/blob/nested-persistent-navigation/packages/go_router/example/lib/stateful_shell_route.dart)\\n- state restore is only for going from background to foreground if the OS reclaims the memory because it needs it\\n- when manually shutting down the app and restarting it, state restore does not work (at least for go_router)\\n\\n# Startup State Restoration\\n- If a user has never used the app\\n    - there is no state to restore and they should land on the landing page\\n- If a user has started the signup process, but has not yet registered an account (they are registered after picking their unique handle)\\n    - return the user to where they were in the signup process\\n- if a user exits out of the signup process before registering via the close button in the app\\n    - clear the app state entirely (including any signup progress)\\n- if a user registers an account successfully\\n    - clear all signup state (they are signed up now, so we don\'t have to go back!)\\n- if a user logs out after logging in\\n    - clear all state\\n- if a user logs in and they have not set their avatar or display name (last step of signup that occurs after registration)\\n    - detect when loading homepage and redirect user to create profile page\\n        - using route guards?\\n        - create profile page needs a logout option\\n        - the display name and avatar can be attached to a User HydratedBloc so that we can cache the avatar and displayname"},{"id":"registering-new-users","metadata":{"permalink":"/quiri-docs/blog/registering-new-users","source":"@site/blog/2024-01-29-registering-new-users.md","title":"Registering New Users with Matrix","description":"For Quiri, we want to register users with a username and an email. Luckily, we can reference how Fluffychat does this!","date":"2024-01-29T00:00:00.000Z","formattedDate":"January 29, 2024","tags":[{"label":"guides","permalink":"/quiri-docs/blog/tags/guides"}],"readingTime":5.48,"truncated":false,"authors":[{"name":"Nigel Maynard","title":"Quiri Founder","url":"https://github.com/nigel-smk","imageURL":"https://github.com/nigel-smk.png","key":"nigel"}],"frontMatter":{"slug":"registering-new-users","title":"Registering New Users with Matrix","authors":["nigel"],"tags":["guides"]},"prevItem":{"title":"Starting and Restarting Sessions","permalink":"/quiri-docs/blog/starting-and-restarting-sessions"},"nextItem":{"title":"Using Ory for Auth with Synapse","permalink":"/quiri-docs/blog/using-ory-for-auth-with-synapse"}},"content":"For Quiri, we want to register users with a username and an email. Luckily, we can reference how Fluffychat does this!\\n\\n[Choosing an avatar and username](https://gitlab.com/famedly/fluffychat/-/blob/5212d7ce4d66fd1465e851aee788ca9f4f6537b8/lib/pages/connect/connect_page.dart#L31-97)\\n\\n[Provide email and choose a password](https://gitlab.com/famedly/fluffychat/-/blob/e88ce8e91cc992885a109a39270558503aaa455f/lib/pages/sign_up/signup.dart#L76-125)\\n\\nLets find the associated REST calls in the [matrix API spec](https://playground.matrix.org/#overview)\\n\\n## Check if username is available\\n[Matrix spec](https://playground.matrix.org/#get-/_matrix/client/v3/register/available)\\n- no auth required\\n- fluffychat doesn\'t use this maybe because it doesn\'t reserve the username?\\n- should be useful for username selection screen\\n\\n\\n## Register\\n[SDK code](https://github.com/famedly/matrix-dart-sdk/blob/544888fe33a14e0610b2916b5069656a06aeb299/lib/src/client.dart#L450-L490) | [Matrix Spec](https://playground.matrix.org/#post-/_matrix/client/v3/register)\\n- no auth required\\n- when hitting the `matrix.org` server with only a username, it returns a `401` with a response body that tells you the \\"authentication flows\\" that are available to you for this endpoint on this server.\\n```\\n{\\n    \\"session\\": \\"jgIeMOlHYubxOZYzaFSMCFqJ\\",\\n    \\"flows\\": [\\n        {\\n            \\"stages\\": [\\n                \\"m.login.recaptcha\\",\\n                \\"m.login.terms\\",\\n                \\"m.login.email.identity\\"\\n            ]\\n        }\\n    ],\\n    \\"params\\": {\\n        \\"m.login.recaptcha\\": {\\n            \\"public_key\\": \\"6LcgI54UAAAAABGdGmruw6DdOocFpYVdjYBRe4zb\\"\\n        },\\n        \\"m.login.terms\\": {\\n            \\"policies\\": {\\n                \\"privacy_policy\\": {\\n                    \\"version\\": \\"1.0\\",\\n                    \\"en\\": {\\n                        \\"name\\": \\"Terms and Conditions\\",\\n                        \\"url\\": \\"https://matrix-client.matrix.org/_matrix/consent?v=1.0\\"\\n                    }\\n                }\\n            }\\n        }\\n    }\\n}\\n``` \\nIn this case the \\"authentication\\" is the steps that you will need to go through in order to register on this server; pass recaptcha, agree to terms and conditions and go through an email verification flow (receive an email and click the button in it)\\n\\nOn my local dockerized synapse instance I wanted to start with the simplest [configuration](https://matrix-org.github.io/synapse/latest/usage/configuration/config_documentation.html) and build up from there. \\n\\nThe basic configuration does not allow any registrations.\\nAdding `enable_registration: true` will get you a startup error telling you that you shouldn\'t allow registrations without some additional measures to confirm identity (like the steps above that matrix.org makes you go through). Otherwise people can spam requests to create accounts.\\n\\nOn my local though, it tells me that I can add `enable_registration_without_verification: true` to allow such registrations anyways.\\n\\nAfter doing that I naively try to submit a registration request with just a username and an email:\\n```\\ncurl --location \'localhost:8008/_matrix/client/v3/register\' \\\\\\n--header \'Content-Type: application/json\' \\\\\\n--data \'{\\n    \\"username\\": \\"cheeeeky_monkey\\",\\n    \\"password\\": \\"password\\"\\n}\'\\n```\\nI get back this cryptic response and it does not register a user.\\n```\\n{\\n    \\"session\\": \\"bFygXrPrCVAOztdAJyjjDOim\\",\\n    \\"flows\\": [\\n        {\\n            \\"stages\\": [\\n                \\"m.login.dummy\\"\\n            ]\\n        }\\n    ],\\n    \\"params\\": {}\\n}\\n```\\n\\nAfter reading through the [User-Interactive Authentication API docs](https://spec.matrix.org/v1.9/client-server-api/#user-interactive-authentication-api) I learned that this is my server telling me that I have one flow that I can take to authenticate this registration request. And that path is to perform no flow! All I have to do is add the auth parameter to my registration request.\\n```\\n{\\n    \\"password\\": \\"ilovebananas\\",\\n    \\"username\\": \\"cheeky_monkey\\",\\n    \\"auth\\": {\\n        \\"session\\": \\"qRFAzYnVJgHQdobMkUhOQlUU\\",\\n        \\"type\\": \\"m.login.dummy\\"\\n    }\\n}\\n```\\n\\nThe session is optional in this case because the flow only has a single step (multiple step flows will require sending the same session token). Including the `m.login.dummy` auth type basically is just a little hoop we have to jump through to make this request without going through any actual flow.\\n\\nWe registered a user! But as per that earlier error\'s advice, we can\'t go public with this configuration. For Quiri we want to register users with their emails so it\'s time to figure out how to configure the server to require email for registration and also configure it to send the emails!\\n\\n\\n## Registering a user with an email\\n\\n### Setting up a dev email server\\nAt first I was looking into different services like SendGrid (will probably use this for the actual deployment) but then I realized I should be able to use an SMTP server hosted in a local docker container!\\n\\nSo I am trying [smtp4dev](https://github.com/rnwood/smtp4dev)\\n\\n### Get the registration token\\n- [API doc](https://playground.matrix.org/#post-/_matrix/client/v3/register/email/requestToken)\\n```\\ncurl --location \'localhost:8008/_matrix/client/v3/register/email/requestToken\' \\\\\\n--header \'Content-Type: application/json\' \\\\\\n--data-raw \'{\\n  \\"client_secret\\": \\"monkeys_are_GREAT\\",\\n  \\"email\\": \\"alice@example.org\\",\\n  \\"next_link\\": \\"https://example.org/congratulations.html\\",\\n  \\"send_attempt\\": 1\\n}\'\\n```\\n- the client secret is any string invented by the client\\n- this sends the email with the validation link!\\n- the response is an sid\\n    ```\\n    {\\n        \\"sid\\": \\"WurCLwjxFYIGiTIz\\"\\n    }\\n    ```\\n\\n### Click the verification link\\n- you cannot continue with registration until that link is clicked\\n- go to `localhost:5005` for the smtp4dev interface and open the email\\n- the link is currently https, which won\'t work\\n    - I should figure out how to make it use http for the link\\n    - for now just copy paste it from the email into the browser and edit to `http`\\n    - it will redirect to a 404 page because I haven\'t set up a redirect page yet\\n    - but it did succeed!\\n\\n### Complete the registration\\n```\\ncurl --location \'localhost:8008/_matrix/client/v3/register\' \\\\\\n--header \'Content-Type: application/json\' \\\\\\n--data \'{\\n    \\"device_id\\": \\"GHTYAJCE\\",\\n    \\"inhibit_login\\": false,\\n    \\"initial_device_display_name\\": \\"Jungle Phone\\",\\n    \\"password\\": \\"ilovebananas\\",\\n    \\"refresh_token\\": false,\\n    \\"username\\": \\"cheeky_monkey_email\\",\\n    \\"auth\\": {\\n        \\"session\\": \\"bdZxZeFmpPxdAuSVoGalmiPC\\",\\n        \\"type\\": \\"m.login.email.identity\\",\\n        \\"threepid_creds\\": {\\n            \\"sid\\": \\"ygxQvHncMIMQzFTk\\",\\n            \\"client_secret\\": \\"monkeys_are_GREAT\\"\\n        }\\n    }\\n}\'\\n```\\n- the sid is from the previous email registration request\\n- the client_secret was provided in the previous email registration request\\n- this will fail if the user has not yet clicked the link in their email\\n- if they have clicked that link, the user is now registered, your first token is returned and we\'re off!\\n\\n## Email Registration User Experience\\n- User is asked for email and password\\n    - random client_secret is generated by client and stored in localstorage\\n    - request is sent to matrix to send verification email\\n        - sid of response is held in local storage\\n    - password is held in local storage?\\n        - security risk?\\n- User is taken to a page informing them that they must click the link in the email to continue\\n    - include button to resend the request\\n- when the button is clicked in the email, we should try to send them into the app?\\n    - or just give them a message that they should go back to the app to continue\\n- whenever they return to the \\"check your email\\" page, try to register them with no password\\n    - if they have yet to have validated, it will respond with EMAIL_NOT_VALIDATED\\n    - if they have validated it will respond with NO_PASSWORD\\n- once the NO_PASSWORD response comes up, move the user through the username selection process\\n- once they have selected a username, send the final registration request with username, password, email token (sid)\\n    - an access token will be returned and the user is on their merry way\\n- make sure to remove the password from local storage!\\n\\nThroughout the above process, if the user closes the app and re-opens they should be brought back to the screen that they were at. The information that they provide needs to be stored in \\"localstorage\\" until they make the final registration call."},{"id":"using-ory-for-auth-with-synapse","metadata":{"permalink":"/quiri-docs/blog/using-ory-for-auth-with-synapse","source":"@site/blog/2023-10-30-using-ory-for-auth-with-synapse.md","title":"Using Ory for Auth with Synapse","description":"We are now working on the designs for the MVP app which has me figuring out user signup/signin. While the matrix folks have built-in a variety of authentication methods, I am inclined to use a dedicated signup/signin service and let matrix focus on chat.","date":"2023-10-30T00:00:00.000Z","formattedDate":"October 30, 2023","tags":[{"label":"guides","permalink":"/quiri-docs/blog/tags/guides"}],"readingTime":3.71,"truncated":false,"authors":[{"name":"Nigel Maynard","title":"Quiri Founder","url":"https://github.com/nigel-smk","imageURL":"https://github.com/nigel-smk.png","key":"nigel"}],"frontMatter":{"slug":"using-ory-for-auth-with-synapse","title":"Using Ory for Auth with Synapse","authors":["nigel"],"tags":["guides"]},"prevItem":{"title":"Registering New Users with Matrix","permalink":"/quiri-docs/blog/registering-new-users"},"nextItem":{"title":"Project Structure and State Management in Flutter","permalink":"/quiri-docs/blog/project-structure-and-state-management-in-flutter"}},"content":"We are now working on the designs for the MVP app which has me figuring out user signup/signin. While the matrix folks have built-in a variety of authentication methods, I am inclined to use a dedicated signup/signin service and let matrix focus on chat.\\n\\nThis post is my effort to lay out my understanding of the options that Synapse offers and the tradeoffs they have.\\n\\n## Research\\n- [sparse synapse docs regarding oidc](https://matrix-org.github.io/synapse/latest/usage/configuration/user_authentication/index.html)\\n    - lists Hydra as a tested provider but doesn\'t include it in any examples\\n    - is this the same thing as Matrix Authentication Service?\\n    - this looks like it is Matrix baking in additional authentication mechanisms rather than totally offloading the authentication to something like MAS...\\n- [dedicated site regarding matrix migrating to OIDC](https://areweoidcyet.com/)\\n    - lists MAS alongside Keycloak under OpenID Providers. Does Ory Hydra fit in the same category and why is Hydra listed as [\\"tested\\" here](https://matrix-org.github.io/synapse/latest/openid.html) but not listed in this doc?\\n- [areweoidcyet client implementation guide](https://areweoidcyet.com/client-implementation-guide/)\\n    - provides more details on client flows\\n    - lots of details on how the client interacts with an \\"oidc\\" homeserver\\n- [matrix playground account management requests](https://playground.matrix.org/#post-/_matrix/client/v3/register)\\n- [matrix spec 1.8 (including registration/authentication)](https://spec.matrix.org/v1.8/client-server-api/#client-authentication)\\n- [merged PR that moves auth to OIDC](https://github.com/matrix-org/synapse/pull/15582)\\n    - merged May 2023\\n    - note the deprecation of old registration endpoints\\n    - contains detailed notes on how to run the matrix-authentication-service\\n        - do we need to run that or is it baked in now?\\n- [matrix-authentication-service repo](https://github.com/matrix-org/matrix-authentication-service)\\n    - can I use something like Hydra instead of MAS?\\n    - looks like you could work with Hydra as an \\"upstream\\" IDP but if I can just use it as the main one then why run MAS as well?\\n    - [some details about MAS from areweoidcyet.com](https://areweoidcyet.com/#whats-this-matrix-authentication-service-that-ive-heard-about)\\n- [MAS documentation](https://matrix-org.github.io/matrix-authentication-service/index.html)\\n    - good introduction to how the matrix chat server and the auth server will interact\\n- [PR for bringing delegated auth to an official release](https://github.com/matrix-org/synapse/issues/15573)\\n    - still open\\n    - still experimental\\n- [the matrix spec change request for delegating auth](https://github.com/matrix-org/matrix-spec-proposals/pull/3861/files)\\n    - has more details about the motivation and the current state of auth\\n- [Matrix OpenID Connect Playground repo](https://github.com/vector-im/oidc-playground)\\n    - this is hosted somewhere\\n    - not sure how it is useful to me\\n- [Blog post about manually integrating Kratos and Hydra (and why)](https://blog.px.dev/open-source-auth/)\\n- [Kratos issue comment that appears to be the most complete integration guide?](https://github.com/ory/kratos/issues/273#issuecomment-1305388654)\\n- [Kratos/Hydra critique](https://gruchalski.com/posts/2021-04-10-ory-reference-docker-compose-and-thoughts-on-the-platform/)\\n\\n\\n## Hosting My Own Hydra OIDC Provider and Using Already Built-in OIDC to Authenticate All users\\nIt seems that while the proposal to have all matrix clients authenticate with matrix via OIDC, it is still just a proposal and is currently experimental. I feel that I now understand how I can have users that are managed by Ory Hydra/Kratos but have accounts on my Matrix server.\\n- Kratos offers signup/signin services via API that can be used to create accounts\\n- Hydra provides the OIDC interface so that users can \\"login using Ory\\" in the same way that they might \\"sign in using google\\"\\n    - while google has other applications and things that you might use your google account for, my Ory deployment would only be holding their identities (not the best explanation)\\n- on the Matrix server side, I configure the server to only allow auth through oidc and only configure Ory as the provider\\n    - google, auth0, etc are able to be configured as downstream providers to Ory\\n- if the proposal takes off, hopefully it\'s not too complicated to shift to using the Hydra/Kratos as the OIDC Provider rather than MAS\\n\\n### To Investigate\\n- can we obscure the Matrix server to Ory auth process in a way that makes the user feel like they are using a basic login and not using a social-like signin?\\n- how hard is it going to be to integrate Kratos and Hydra?\\n- Is this overcomplicated?\\n\\n## Using PasswordProvider Module to Directly integrate with Kratos\\n- does this restrict the login/security options that Kratos offers?\\n- does this reduce the complexity that much?\\n\\n\\n## Just use the built-in auth as it is\\n- limited to the auth options that are already made available\\n    - there are a bunch of them...\\n- less secure?\\n    - another auth rewrite from a team that should be focussing on chat?\\n    - they are very security focussed though...\\n- looks like I\'m going with this because the Kratos/Hydra integration is not looking straightforward enough at this time\\n    - in the future that does seem like the best option"},{"id":"project-structure-and-state-management-in-flutter","metadata":{"permalink":"/quiri-docs/blog/project-structure-and-state-management-in-flutter","source":"@site/blog/2022-11-15-project-structure-and-state-management-in-flutter copy 2.md","title":"Project Structure and State Management in Flutter","description":"Flutter is a compelling technology but it is not very mature so there are some challenges when it comes to filling in the functionality that is missing from the core libraries. I have spent a lot of time reading different blogs, etc. to try to get some guidance and hopefully avoid some common pitfalls. One resource that has been useful is codewithandrea.com. I am going to be referencing his riverpod and other architecture articles to inform my library architectural decisions.","date":"2022-11-15T00:00:00.000Z","formattedDate":"November 15, 2022","tags":[{"label":"guides","permalink":"/quiri-docs/blog/tags/guides"}],"readingTime":0.4,"truncated":false,"authors":[{"name":"Nigel Maynard","title":"Quiri Founder","url":"https://github.com/nigel-smk","imageURL":"https://github.com/nigel-smk.png","key":"nigel"}],"frontMatter":{"slug":"project-structure-and-state-management-in-flutter","title":"Project Structure and State Management in Flutter","authors":["nigel"],"tags":["guides"]},"prevItem":{"title":"Using Ory for Auth with Synapse","permalink":"/quiri-docs/blog/using-ory-for-auth-with-synapse"},"nextItem":{"title":"Getting Started With the Matrix API","permalink":"/quiri-docs/blog/getting-started-matrix-api"}},"content":"Flutter is a compelling technology but it is not very mature so there are some challenges when it comes to filling in the functionality that is missing from the core libraries. I have spent a lot of time reading different blogs, etc. to try to get some guidance and hopefully avoid some common pitfalls. One resource that has been useful is [codewithandrea.com](https://codewithandrea.com/tutorials/). I am going to be referencing his riverpod and other architecture articles to inform my library architectural decisions."},{"id":"getting-started-matrix-api","metadata":{"permalink":"/quiri-docs/blog/getting-started-matrix-api","source":"@site/blog/2022-08-12-getting-started-matrix-api.md","title":"Getting Started With the Matrix API","description":"After some exploration of Android development (specifically jetpack compose), I finally took a proper swing at Flutter and while jetpack compose seems like a powerful tool and I would love to get to know kotlin better, the cross-platform development and cross-platform design was just too alluring.","date":"2022-08-12T00:00:00.000Z","formattedDate":"August 12, 2022","tags":[{"label":"guides","permalink":"/quiri-docs/blog/tags/guides"}],"readingTime":0.845,"truncated":false,"authors":[{"name":"Nigel Maynard","title":"Quiri Founder","url":"https://github.com/nigel-smk","imageURL":"https://github.com/nigel-smk.png","key":"nigel"}],"frontMatter":{"slug":"getting-started-matrix-api","title":"Getting Started With the Matrix API","authors":["nigel"],"tags":["guides"]},"prevItem":{"title":"Project Structure and State Management in Flutter","permalink":"/quiri-docs/blog/project-structure-and-state-management-in-flutter"},"nextItem":{"title":"Getting Started With Flutter","permalink":"/quiri-docs/blog/getting-started-with-flutter"}},"content":"After some exploration of Android development (specifically jetpack compose), I finally took a proper swing at Flutter and while jetpack compose seems like a powerful tool and I would love to get to know kotlin better, the cross-platform development and cross-platform design was just too alluring. \\n\\nI figured I would start with a login screen as it would get me interacting with state and making an API call. I found some widget online that gave me most of the UI, leaving me to figure out constructing the login API request from the form inputs. \\n\\nAt first I was wary of using an SDK that was not created by the Matrix team but the Famedly folks are actively contributing to it and when it comes down to it, it is just sending HTTP requests to the API. So the first thing was [adding the SDK](https://gitlab.com/famedly/company/frontend/famedlysdk) as a dependency.\\n\\nIt is also important for me to start getting to know the matrix API in general so I found their [API reference](https://matrix.org/docs/api/#overview)."},{"id":"getting-started-with-flutter","metadata":{"permalink":"/quiri-docs/blog/getting-started-with-flutter","source":"@site/blog/2022-06-12-getting-started-with-flutter.md","title":"Getting Started With Flutter","description":"After putting quite a bit of time into getting Element for Android working as a library so that I could wrap it in my own package, I was finding that even writing a simple feature was proving difficult. I did some evaluation of the amount of energy that would be required to get up to speed with android in a way that would be required for me to make any meaningful progress on quiri and Flutter started to look more attractive.","date":"2022-06-12T00:00:00.000Z","formattedDate":"June 12, 2022","tags":[{"label":"guides","permalink":"/quiri-docs/blog/tags/guides"}],"readingTime":2.905,"truncated":false,"authors":[{"name":"Nigel Maynard","title":"Quiri Founder","url":"https://github.com/nigel-smk","imageURL":"https://github.com/nigel-smk.png","key":"nigel"}],"frontMatter":{"slug":"getting-started-with-flutter","title":"Getting Started With Flutter","authors":["nigel"],"tags":["guides"]},"prevItem":{"title":"Getting Started With the Matrix API","permalink":"/quiri-docs/blog/getting-started-matrix-api"}},"content":"After putting quite a bit of time into getting Element for Android working as a library so that I could wrap it in my own package, I was finding that even writing a simple feature was proving difficult. I did some evaluation of the amount of energy that would be required to get up to speed with android in a way that would be required for me to make any meaningful progress on quiri and Flutter started to look more attractive.\\n\\nWith the wrapped Element Android version of the app distributed out to Josh, Loisel and Anton, we had collected some solid sample conversations that have helped to inform which features are essential to the quiri experience and which new features we might like to build on top of it. This has given me more confidence in building from scratch using Flutter. \\n\\n[There is an actively maintained matrix SDK for flutter](https://gitlab.com/famedly/company/frontend/famedlysdk) as well as the [associated open-source app that depends on it (which has decent reviews in the Play Store)](https://gitlab.com/famedly/fluffychat). So my thinking is that it\'s probably a similar effort for me to get up speed on android vs build from scratch in Flutter (maybe I will just build on top of fluffychat...) but if I go with Flutter at least I will understand how all of the code works (because I will write it). Whereas the experience with android right now is one of generally being frustrated and lost in a large and complex codebase. \\n\\nWhile I feel that there is some risk that Flutter will end up being the wrong tool due to some shortcomings, [it appears to be a pretty solid tool and Google is quite active in improving it.](https://flutter.dev/events/io-2022) If it plays out well, it will be easy enough to have desktop and web clients as well as android and iOS.\\n\\n# Getting Started\\nI had just bought a new macbook so I have had a pretty fresh start. Here are the things that I already installed:\\n- iTerm2\\n- ohmyzsh\\n- xcode and the xcode command line tools (big download)\\n- vs code\\n- android studio (to maybe write flutter in)\\n- docker desktop\\n\\nFor flutter I just jumped to their [install homepage](https://docs.flutter.dev/get-started/install) and went from there.\\n\\n`flutter doctor` raised a couple of issues\\n- `Unable to locate Android SDK.`\\n  - I needed to open Android Studio, which had a first time run wizard that installed the android SDK for me\\n- `CocoaPods not installed.`\\n  - Just followed [their instructions](https://guides.cocoapods.org/using/getting-started.html#installation) to install cocoapods as well.\\n- `cmdline-tools component is missing`\\n  - on the Android Studio startup modal, click `More actions` > `SDK Manager` > `SDK Tools` tab > check `Android SDK command line tools (latest)` and then `Apply` or `OK`\\n- `Android license status unknown.`\\n  - `flutter doctor --android-licenses`\\n\\nI am going to start with just android devices so I need to take the [Android Setup](https://docs.flutter.dev/get-started/install/macos#android-setup) steps as well.\\n\\n# IDE\\nI chose android studio because I imagine google has put effort into making it the ideal development experience. I could definitely see myself switching to VS code though.\\n\\nI got as far as running the sample app on my device.\\n\\n# Next steps\\nI think that I will follow the more detailed intro to creating an app that follows this setup. And then probably go back to the Flutter course I started on Udemy a while back. \\n\\nI will need to get some initial designs going with Loisel as well to help guide my efforts."}]}')}}]);