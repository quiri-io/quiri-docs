"use strict";(self.webpackChunkquiri_docs=self.webpackChunkquiri_docs||[]).push([[6338],{3905:function(e,t,n){n.d(t,{Zo:function(){return d},kt:function(){return m}});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},d=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,l=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),u=c(n),m=i,h=u["".concat(l,".").concat(m)]||u[m]||p[m]||r;return n?a.createElement(h,o(o({ref:t},d),{},{components:n})):a.createElement(h,o({ref:t},d))}));function m(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=u;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:i,o[1]=s;for(var c=2;c<r;c++)o[c]=n[c];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},6195:function(e,t,n){n.r(t),n.d(t,{assets:function(){return d},contentTitle:function(){return l},default:function(){return m},frontMatter:function(){return s},metadata:function(){return c},toc:function(){return p}});var a=n(7462),i=n(3366),r=(n(7294),n(3905)),o=["components"],s={slug:"listening-for-new-messages-with-the-matrix-sdk",title:"Listening for New Messages With the Matrix SDK",authors:["nigel"],tags:["quiri","guide"]},l=void 0,c={permalink:"/quiri-docs/blog/listening-for-new-messages-with-the-matrix-sdk",source:"@site/blog/2024-12-19-listening-for-new-messages-with-the-matrix-sdk copy.md",title:"Listening for New Messages With the Matrix SDK",description:"Background",date:"2024-12-19T00:00:00.000Z",formattedDate:"December 19, 2024",tags:[{label:"quiri",permalink:"/quiri-docs/blog/tags/quiri"},{label:"guide",permalink:"/quiri-docs/blog/tags/guide"}],readingTime:1.84,truncated:!1,authors:[{name:"Nigel Maynard",title:"Quiri Founder",url:"https://github.com/nigel-smk",imageURL:"https://github.com/nigel-smk.png",key:"nigel"}],frontMatter:{slug:"listening-for-new-messages-with-the-matrix-sdk",title:"Listening for New Messages With the Matrix SDK",authors:["nigel"],tags:["quiri","guide"]},prevItem:{title:"Streaming Repositories With Bloc",permalink:"/quiri-docs/blog/streaming-repositories-with-bloc"},nextItem:{title:"Sending and Accepting Room Invites",permalink:"/quiri-docs/blog/sending-and-accepting-room-invites"}},d={authorsImageUrls:[void 0]},p=[{value:"Background",id:"background",level:2},{value:"Listening for events",id:"listening-for-events",level:2},{value:"Replicating the state in the client",id:"replicating-the-state-in-the-client",level:2},{value:"Reacting to new events in the UI",id:"reacting-to-new-events-in-the-ui",level:2}],u={toc:p};function m(e){var t=e.components,n=(0,i.Z)(e,o);return(0,r.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"background"},"Background"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://matrix.org/docs/matrix-concepts/rooms_and_events/"},"Almost all actions in matrix are expressed as ",(0,r.kt)("inlineCode",{parentName:"a"},"users")," sending ",(0,r.kt)("inlineCode",{parentName:"a"},"events")," to ",(0,r.kt)("inlineCode",{parentName:"a"},"rooms"),".")," This makes intuitive sense when it comes to message events but works equally well for non-message events (e.g. add user event, change room name event, etc). When a user adds an event to a room, ",(0,r.kt)("a",{parentName:"p",href:"https://matrix.org/docs/matrix-concepts/elements-of-matrix/#client"},"it is first added to the event graph on their personal client, then it is replicated to the user's home server and then it is replicated to all other clients that are in that room.")," Quiri is written in Dart and uses the matrix dart sdk to handle a lot of the client-server relationship. This includes maintaining the local copy of the current state of a room's state and listening for updates to that room's state. This guide goes into details about how that relationship is maintained so that we can build the quiri client appropriately."),(0,r.kt)("h2",{id:"listening-for-events"},"Listening for events"),(0,r.kt)("p",null,"On ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/quiri-io/quiri_flutter/blob/8405271b51a3c85884502042387289cdc083149f/lib/config/configure_matrix.dart#L4-L11"},"app startup"),", we currently call the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/famedly/matrix-dart-sdk/blob/501c457ea130481ba5b52d45d4d0ff37b8707964/lib/src/client.dart#L1502-L1519"},"init method"),". This method does a number of things including kicking off the first ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/famedly/matrix-dart-sdk/blob/501c457ea130481ba5b52d45d4d0ff37b8707964/lib/src/client.dart#L1789-L1800"},"_sync")," request."),(0,r.kt)("p",null,"This sync call can be awaited as a whole, or you can provide the ",(0,r.kt)("inlineCode",{parentName:"p"},"waitForFirstSync")," as ",(0,r.kt)("inlineCode",{parentName:"p"},"false")," and instead await the ",(0,r.kt)("inlineCode",{parentName:"p"},"roomsLoading"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"_accountDataLoading")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"userDeviceKeysLoading")," futures individually. We will await on the init for now for simplicity."),(0,r.kt)("p",null,"After the initial sync, the client will begin a ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/famedly/matrix-dart-sdk/blob/501c457ea130481ba5b52d45d4d0ff37b8707964/lib/src/client.dart#L1771-L1781"},"_backgroundSync")," that ",(0,r.kt)("a",{parentName:"p",href:"https://spec.matrix.org/latest/#architecture"},"long polls")," every 30 seconds (configurable)."),(0,r.kt)("h2",{id:"replicating-the-state-in-the-client"},"Replicating the state in the client"),(0,r.kt)("p",null,"Each sync job uses the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/famedly/matrix-dart-sdk/blob/501c457ea130481ba5b52d45d4d0ff37b8707964/lib/src/client.dart#L1969-L2021"},"_handleSync")," method to perform the appropriate updates to state."),(0,r.kt)("p",null,"For example, in the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/famedly/matrix-dart-sdk/blob/501c457ea130481ba5b52d45d4d0ff37b8707964/lib/src/client.dart#L2277-L2284"},(0,r.kt)("inlineCode",{parentName:"a"},"_handleRoomEvents")," sub-handler the updates are made in the following order:")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"the in-memory state (accessible from the SDK client object e.g. ",(0,r.kt)("inlineCode",{parentName:"li"},"client.rooms"),")"),(0,r.kt)("li",{parentName:"ul"},"the client side database for persistent storage"),(0,r.kt)("li",{parentName:"ul"},"the SDK's ",(0,r.kt)("a",{parentName:"li",href:"https://github.com/famedly/matrix-dart-sdk/blob/501c457ea130481ba5b52d45d4d0ff37b8707964/lib/src/client.dart#L1254-L1285"},"exposed event streams"))),(0,r.kt)("h2",{id:"reacting-to-new-events-in-the-ui"},"Reacting to new events in the UI"),(0,r.kt)("p",null,"In particular, how do we know when new messages have arrived? Let's look at how Fluffychat does it. First let's look at ",(0,r.kt)("a",{parentName:"p",href:"https://gitlab.com/famedly/fluffychat/-/blob/f19bbcd0102e1b2982af9b988e9e6f7de9cc33a7/lib/pages/chat/chat_event_list.dart#L104-142"},"where they render their chat boxes"),". The messages are found in a room's ",(0,r.kt)("inlineCode",{parentName:"p"},"timeline"),". The ",(0,r.kt)("inlineCode",{parentName:"p"},"timeline")," is returned from the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/famedly/matrix-dart-sdk/blob/42f44de2b13588aede30d5f64fc381ee1a72f90c/lib/src/room.dart#L1467-L1479"},"SDK getTimeline method"),". An ",(0,r.kt)("inlineCode",{parentName:"p"},"onUpdate")," callback is passed to allow the UI to react to new messages arriving. Here is where ",(0,r.kt)("a",{parentName:"p",href:"https://gitlab.com/famedly/fluffychat/-/blob/1911004d0540d3dea51da327dd32d82d061675f5/lib/pages/chat/chat.dart#L287-340"},"Fluffychat sets up the timeline listener for new messages")))}m.isMDXComponent=!0}}]);