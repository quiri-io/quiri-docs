"use strict";(self.webpackChunkquiri_docs=self.webpackChunkquiri_docs||[]).push([[3398],{3905:function(e,t,n){n.d(t,{Zo:function(){return p},kt:function(){return m}});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),u=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},p=function(e){var t=u(e.components);return a.createElement(s.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),h=u(n),m=r,d=h["".concat(s,".").concat(m)]||h[m]||c[m]||i;return n?a.createElement(d,l(l({ref:t},p),{},{components:n})):a.createElement(d,l({ref:t},p))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,l=new Array(i);l[0]=h;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o.mdxType="string"==typeof e?e:r,l[1]=o;for(var u=2;u<i;u++)l[u]=n[u];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},8536:function(e,t,n){n.r(t),n.d(t,{assets:function(){return p},contentTitle:function(){return s},default:function(){return m},frontMatter:function(){return o},metadata:function(){return u},toc:function(){return c}});var a=n(7462),r=n(3366),i=(n(7294),n(3905)),l=["components"],o={},s="Registering New Users",u={unversionedId:"Understanding Matrix and the Dart Matrix SDK/registering-new-users",id:"Understanding Matrix and the Dart Matrix SDK/registering-new-users",title:"Registering New Users",description:"For Quiri, we want to register users with a username and an email. Luckily, we can reference how Fluffychat does this!",source:"@site/docs/Understanding Matrix and the Dart Matrix SDK/registering-new-users.md",sourceDirName:"Understanding Matrix and the Dart Matrix SDK",slug:"/Understanding Matrix and the Dart Matrix SDK/registering-new-users",permalink:"/quiri-docs/Understanding Matrix and the Dart Matrix SDK/registering-new-users",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Push Notifications",permalink:"/quiri-docs/Understanding Matrix and the Dart Matrix SDK/push-notifications"},next:{title:"Room Invites",permalink:"/quiri-docs/Understanding Matrix and the Dart Matrix SDK/room-invites"}},p={},c=[{value:"Check if username is available",id:"check-if-username-is-available",level:2},{value:"Register",id:"register",level:2},{value:"Registering a user with an email",id:"registering-a-user-with-an-email",level:2},{value:"Setting up a dev email server",id:"setting-up-a-dev-email-server",level:3},{value:"Get the registration token",id:"get-the-registration-token",level:3},{value:"Click the verification link",id:"click-the-verification-link",level:3},{value:"Complete the registration",id:"complete-the-registration",level:3},{value:"Email Registration User Experience",id:"email-registration-user-experience",level:2}],h={toc:c};function m(e){var t=e.components,n=(0,r.Z)(e,l);return(0,i.kt)("wrapper",(0,a.Z)({},h,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"registering-new-users"},"Registering New Users"),(0,i.kt)("p",null,"For Quiri, we want to register users with a username and an email. Luckily, we can reference how Fluffychat does this!"),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://gitlab.com/famedly/fluffychat/-/blob/5212d7ce4d66fd1465e851aee788ca9f4f6537b8/lib/pages/connect/connect_page.dart#L31-97"},"Choosing an avatar and username")),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://gitlab.com/famedly/fluffychat/-/blob/e88ce8e91cc992885a109a39270558503aaa455f/lib/pages/sign_up/signup.dart#L76-125"},"Provide email and choose a password")),(0,i.kt)("p",null,"Lets find the associated REST calls in the ",(0,i.kt)("a",{parentName:"p",href:"https://playground.matrix.org/#overview"},"matrix API spec")),(0,i.kt)("h2",{id:"check-if-username-is-available"},"Check if username is available"),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://playground.matrix.org/#get-/_matrix/client/v3/register/available"},"Matrix spec")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"no auth required"),(0,i.kt)("li",{parentName:"ul"},"fluffychat doesn't use this maybe because it doesn't reserve the username?"),(0,i.kt)("li",{parentName:"ul"},"should be useful for username selection screen")),(0,i.kt)("h2",{id:"register"},"Register"),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://github.com/famedly/matrix-dart-sdk/blob/544888fe33a14e0610b2916b5069656a06aeb299/lib/src/client.dart#L450-L490"},"SDK code")," | ",(0,i.kt)("a",{parentName:"p",href:"https://playground.matrix.org/#post-/_matrix/client/v3/register"},"Matrix Spec")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"no auth required"),(0,i.kt)("li",{parentName:"ul"},"when hitting the ",(0,i.kt)("inlineCode",{parentName:"li"},"matrix.org")," server with only a username, it returns a ",(0,i.kt)("inlineCode",{parentName:"li"},"401"),' with a response body that tells you the "authentication flows" that are available to you for this endpoint on this server.')),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'{\n    "session": "jgIeMOlHYubxOZYzaFSMCFqJ",\n    "flows": [\n        {\n            "stages": [\n                "m.login.recaptcha",\n                "m.login.terms",\n                "m.login.email.identity"\n            ]\n        }\n    ],\n    "params": {\n        "m.login.recaptcha": {\n            "public_key": "6LcgI54UAAAAABGdGmruw6DdOocFpYVdjYBRe4zb"\n        },\n        "m.login.terms": {\n            "policies": {\n                "privacy_policy": {\n                    "version": "1.0",\n                    "en": {\n                        "name": "Terms and Conditions",\n                        "url": "https://matrix-client.matrix.org/_matrix/consent?v=1.0"\n                    }\n                }\n            }\n        }\n    }\n}\n')),(0,i.kt)("p",null,'In this case the "authentication" is the steps that you will need to go through in order to register on this server; pass recaptcha, agree to terms and conditions and go through an email verification flow (receive an email and click the button in it)'),(0,i.kt)("p",null,"On my local dockerized synapse instance I wanted to start with the simplest ",(0,i.kt)("a",{parentName:"p",href:"https://matrix-org.github.io/synapse/latest/usage/configuration/config_documentation.html"},"configuration")," and build up from there. "),(0,i.kt)("p",null,"The basic configuration does not allow any registrations.\nAdding ",(0,i.kt)("inlineCode",{parentName:"p"},"enable_registration: true")," will get you a startup error telling you that you shouldn't allow registrations without some additional measures to confirm identity (like the steps above that matrix.org makes you go through). Otherwise people can spam requests to create accounts."),(0,i.kt)("p",null,"On my local though, it tells me that I can add ",(0,i.kt)("inlineCode",{parentName:"p"},"enable_registration_without_verification: true")," to allow such registrations anyways."),(0,i.kt)("p",null,"After doing that I naively try to submit a registration request with just a username and an email:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'curl --location \'localhost:8008/_matrix/client/v3/register\' \\\n--header \'Content-Type: application/json\' \\\n--data \'{\n    "username": "cheeeeky_monkey",\n    "password": "password"\n}\'\n')),(0,i.kt)("p",null,"I get back this cryptic response and it does not register a user."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'{\n    "session": "bFygXrPrCVAOztdAJyjjDOim",\n    "flows": [\n        {\n            "stages": [\n                "m.login.dummy"\n            ]\n        }\n    ],\n    "params": {}\n}\n')),(0,i.kt)("p",null,"After reading through the ",(0,i.kt)("a",{parentName:"p",href:"https://spec.matrix.org/v1.9/client-server-api/#user-interactive-authentication-api"},"User-Interactive Authentication API docs")," I learned that this is my server telling me that I have one flow that I can take to authenticate this registration request. And that path is to perform no flow! All I have to do is add the auth parameter to my registration request."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'{\n    "password": "ilovebananas",\n    "username": "cheeky_monkey",\n    "auth": {\n        "session": "qRFAzYnVJgHQdobMkUhOQlUU",\n        "type": "m.login.dummy"\n    }\n}\n')),(0,i.kt)("p",null,"The session is optional in this case because the flow only has a single step (multiple step flows will require sending the same session token). Including the ",(0,i.kt)("inlineCode",{parentName:"p"},"m.login.dummy")," auth type basically is just a little hoop we have to jump through to make this request without going through any actual flow."),(0,i.kt)("p",null,"We registered a user! But as per that earlier error's advice, we can't go public with this configuration. For Quiri we want to register users with their emails so it's time to figure out how to configure the server to require email for registration and also configure it to send the emails!"),(0,i.kt)("h2",{id:"registering-a-user-with-an-email"},"Registering a user with an email"),(0,i.kt)("h3",{id:"setting-up-a-dev-email-server"},"Setting up a dev email server"),(0,i.kt)("p",null,"At first I was looking into different services like SendGrid (will probably use this for the actual deployment) but then I realized I should be able to use an SMTP server hosted in a local docker container!"),(0,i.kt)("p",null,"So I am trying ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/rnwood/smtp4dev"},"smtp4dev")),(0,i.kt)("h3",{id:"get-the-registration-token"},"Get the registration token"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://playground.matrix.org/#post-/_matrix/client/v3/register/email/requestToken"},"API doc"))),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'curl --location \'localhost:8008/_matrix/client/v3/register/email/requestToken\' \\\n--header \'Content-Type: application/json\' \\\n--data-raw \'{\n  "client_secret": "monkeys_are_GREAT",\n  "email": "alice@example.org",\n  "next_link": "https://example.org/congratulations.html",\n  "send_attempt": 1\n}\'\n')),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"the client secret is any string invented by the client"),(0,i.kt)("li",{parentName:"ul"},"this sends the email with the validation link!"),(0,i.kt)("li",{parentName:"ul"},"the response is an sid",(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre"},'{\n    "sid": "WurCLwjxFYIGiTIz"\n}\n')))),(0,i.kt)("h3",{id:"click-the-verification-link"},"Click the verification link"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"you cannot continue with registration until that link is clicked"),(0,i.kt)("li",{parentName:"ul"},"go to ",(0,i.kt)("inlineCode",{parentName:"li"},"localhost:5005")," for the smtp4dev interface and open the email"),(0,i.kt)("li",{parentName:"ul"},"the link is currently https, which won't work",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"I should figure out how to make it use http for the link"),(0,i.kt)("li",{parentName:"ul"},"for now just copy paste it from the email into the browser and edit to ",(0,i.kt)("inlineCode",{parentName:"li"},"http")),(0,i.kt)("li",{parentName:"ul"},"it will redirect to a 404 page because I haven't set up a redirect page yet"),(0,i.kt)("li",{parentName:"ul"},"but it did succeed!")))),(0,i.kt)("h3",{id:"complete-the-registration"},"Complete the registration"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'curl --location \'localhost:8008/_matrix/client/v3/register\' \\\n--header \'Content-Type: application/json\' \\\n--data \'{\n    "device_id": "GHTYAJCE",\n    "inhibit_login": false,\n    "initial_device_display_name": "Jungle Phone",\n    "password": "ilovebananas",\n    "refresh_token": false,\n    "username": "cheeky_monkey_email",\n    "auth": {\n        "session": "bdZxZeFmpPxdAuSVoGalmiPC",\n        "type": "m.login.email.identity",\n        "threepid_creds": {\n            "sid": "ygxQvHncMIMQzFTk",\n            "client_secret": "monkeys_are_GREAT"\n        }\n    }\n}\'\n')),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"the sid is from the previous email registration request"),(0,i.kt)("li",{parentName:"ul"},"the client_secret was provided in the previous email registration request"),(0,i.kt)("li",{parentName:"ul"},"this will fail if the user has not yet clicked the link in their email"),(0,i.kt)("li",{parentName:"ul"},"if they have clicked that link, the user is now registered, your first token is returned and we're off!")),(0,i.kt)("h2",{id:"email-registration-user-experience"},"Email Registration User Experience"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"User is asked for email and password",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"random client_secret is generated by client and stored in localstorage"),(0,i.kt)("li",{parentName:"ul"},"request is sent to matrix to send verification email",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"sid of response is held in local storage"))),(0,i.kt)("li",{parentName:"ul"},"password is held in local storage?",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"security risk?"))))),(0,i.kt)("li",{parentName:"ul"},"User is taken to a page informing them that they must click the link in the email to continue",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"include button to resend the request"))),(0,i.kt)("li",{parentName:"ul"},"when the button is clicked in the email, we should try to send them into the app?",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"or just give them a message that they should go back to the app to continue"))),(0,i.kt)("li",{parentName:"ul"},'whenever they return to the "check your email" page, try to register them with no password',(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"if they have yet to have validated, it will respond with EMAIL_NOT_VALIDATED"),(0,i.kt)("li",{parentName:"ul"},"if they have validated it will respond with NO_PASSWORD"))),(0,i.kt)("li",{parentName:"ul"},"once the NO_PASSWORD response comes up, move the user through the username selection process"),(0,i.kt)("li",{parentName:"ul"},"once they have selected a username, send the final registration request with username, password, email token (sid)",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},"an access token will be returned and the user is on their merry way"))),(0,i.kt)("li",{parentName:"ul"},"make sure to remove the password from local storage!")),(0,i.kt)("p",null,'Throughout the above process, if the user closes the app and re-opens they should be brought back to the screen that they were at. The information that they provide needs to be stored in "localstorage" until they make the final registration call.'))}m.isMDXComponent=!0}}]);