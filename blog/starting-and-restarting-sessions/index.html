<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="alternate" type="application/rss+xml" href="/quiri-docs/blog/rss.xml" title="Quiri Docs and Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/quiri-docs/blog/atom.xml" title="Quiri Docs and Blog Atom Feed"><title data-rh="true">Starting and Restarting Sessions | Quiri Docs and Blog</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://quiri-io.github.io/quiri-docs/blog/starting-and-restarting-sessions"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Starting and Restarting Sessions | Quiri Docs and Blog"><meta data-rh="true" name="description" content="Matrix SDK Sessions"><meta data-rh="true" property="og:description" content="Matrix SDK Sessions"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2024-05-12T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/nigel-smk"><meta data-rh="true" property="article:tag" content="guides"><link data-rh="true" rel="icon" href="/quiri-docs/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://quiri-io.github.io/quiri-docs/blog/starting-and-restarting-sessions"><link data-rh="true" rel="alternate" href="https://quiri-io.github.io/quiri-docs/blog/starting-and-restarting-sessions" hreflang="en"><link data-rh="true" rel="alternate" href="https://quiri-io.github.io/quiri-docs/blog/starting-and-restarting-sessions" hreflang="x-default"><link rel="stylesheet" href="/quiri-docs/assets/css/styles.e9529800.css">
<link rel="preload" href="/quiri-docs/assets/js/runtime~main.dbab1971.js" as="script">
<link rel="preload" href="/quiri-docs/assets/js/main.a4186c02.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/quiri-docs/"><div class="navbar__logo"><img src="/quiri-docs/img/quiri_logo.svg" alt="Quiri Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/quiri-docs/img/quiri_logo.svg" alt="Quiri Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">Quiri.dev</b></a><a class="navbar__item navbar__link" href="/quiri-docs/">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/quiri-docs/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/quiri-io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/quiri-docs/blog/streaming-repositories-with-bloc">Streaming Repositories With Bloc</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/quiri-docs/blog/listening-for-new-messages-with-the-matrix-sdk">Listening for New Messages With the Matrix SDK</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/quiri-docs/blog/sending-and-accepting-room-invites">Sending and Accepting Room Invites</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/quiri-docs/blog/opening-a-quiri-with-another-user">Opening a Quiri with Another User</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/quiri-docs/blog/starting-and-restarting-sessions">Starting and Restarting Sessions</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_Ikge" itemprop="headline">Starting and Restarting Sessions</h1><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2024-05-12T00:00:00.000Z" itemprop="datePublished">May 12, 2024</time> · <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_sTYa"><div class="avatar margin-bottom--sm"><a href="https://github.com/nigel-smk" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://github.com/nigel-smk.png" alt="Nigel Maynard"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/nigel-smk" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Nigel Maynard</span></a></div><small class="avatar__subtitle" itemprop="description">Quiri Founder</small></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="matrix-sdk-sessions">Matrix SDK Sessions<a class="hash-link" href="#matrix-sdk-sessions" title="Direct link to heading">​</a></h2><p>Matrix uses access tokens to authenticate user requests. The Dart SDK handles a lot of the token management for us.</p><p>For example, when setting the user&#x27;s display name, there is no way to pass the auth token. This is because it is stored in a class variable and included in the request on our behalf.</p><p>But what happens to the access token when we shut down the app? The instance of the SDK class will be disposed and the token will go with it. This is why the Matrix Client can be provided a databaseBuilder when being created. The SDK will store the access token, amongst other things in this database and <a href="https://github.com/famedly/matrix-dart-sdk/blob/544888fe33a14e0610b2916b5069656a06aeb299/lib/src/client.dart#L1430-L1459" target="_blank" rel="noopener noreferrer">fetch them on startup</a>. This is what will allow us to keep users logged in even when the restart the app.</p><p>There remains the question of how long a client can stay logged in. It seems that the default for FluffyChat is to have long-lived access tokens. But the matrix spec allows for the use of refresh tokens for improved security.There exists a method <a href="https://github.com/famedly/matrix-dart-sdk/blob/501c457ea130481ba5b52d45d4d0ff37b8707964/lib/src/client.dart#L241-L279" target="_blank" rel="noopener noreferrer"><code>refreshAccessToken()</code> that refreshes the access token</a> but it appears that FluffyChat doesn&#x27;t use it... Looks like I&#x27;ll need to schedule a task to refresh the token. </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="other-session-data">Other session data<a class="hash-link" href="#other-session-data" title="Direct link to heading">​</a></h2><p>While the matrix SDK has it&#x27;s own ways to persist session data, there are also cases in which we will want to persist session data (e.g. the user&#x27;s sign-up stage). For these non-matrix session data, we will use the <a href="https://pub.dev/packages/hydrated_bloc" target="_blank" rel="noopener noreferrer">Hydrated Bloc package</a> to securely persist the session data.</p><h1>State Restoration in Flutter</h1><p><a href="https://www.flutteris.com/blog/en/state_restoration" target="_blank" rel="noopener noreferrer">Thorough blog post</a></p><ul><li>maybe use this primarily for navigation state and lean on hydrated bloc for other state?</li><li><a href="https://github.com/flutter/packages/blob/main/packages/go_router/example/lib/others/state_restoration.dart" target="_blank" rel="noopener noreferrer">goRouter state restoration example</a></li><li>might need to use <a href="https://github.com/tolo/flutter_packages/blob/nested-persistent-navigation/packages/go_router/example/lib/stateful_shell_route.dart" target="_blank" rel="noopener noreferrer">statefulShellRoute?</a></li><li>state restore is only for going from background to foreground if the OS reclaims the memory because it needs it</li><li>when manually shutting down the app and restarting it, state restore does not work (at least for go_router)</li></ul><h1>Startup State Restoration</h1><ul><li>If a user has never used the app<ul><li>there is no state to restore and they should land on the landing page</li></ul></li><li>If a user has started the signup process, but has not yet registered an account (they are registered after picking their unique handle)<ul><li>return the user to where they were in the signup process</li></ul></li><li>if a user exits out of the signup process before registering via the close button in the app<ul><li>clear the app state entirely (including any signup progress)</li></ul></li><li>if a user registers an account successfully<ul><li>clear all signup state (they are signed up now, so we don&#x27;t have to go back!)</li></ul></li><li>if a user logs out after logging in<ul><li>clear all state</li></ul></li><li>if a user logs in and they have not set their avatar or display name (last step of signup that occurs after registration)<ul><li>detect when loading homepage and redirect user to create profile page<ul><li>using route guards?</li><li>create profile page needs a logout option</li><li>the display name and avatar can be attached to a User HydratedBloc so that we can cache the avatar and displayname</li></ul></li></ul></li></ul></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_u0Nl"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/quiri-docs/blog/tags/guides">guides</a></li></ul></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/quiri-docs/blog/opening-a-quiri-with-another-user"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Opening a Quiri with Another User</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/quiri-docs/blog/registering-new-users"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Registering New Users with Matrix</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#matrix-sdk-sessions" class="table-of-contents__link toc-highlight">Matrix SDK Sessions</a></li><li><a href="#other-session-data" class="table-of-contents__link toc-highlight">Other session data</a></li></ul></div></div></div></div></div></div>
<script src="/quiri-docs/assets/js/runtime~main.dbab1971.js"></script>
<script src="/quiri-docs/assets/js/main.a4186c02.js"></script>
</body>
</html>